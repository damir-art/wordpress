# Три варианта создания цикла WordPress
В WordPress существует четыре способа построения циклов:
- стандартный цикл `if( have_posts() )`
- цикл на основе `query_posts()`
- дополнительный цикл на основе `WP_Query{}`
- дополнительный цикл на основе `get_posts()`

Все циклы работают с одними и теми же тегами параметрами и функциями. Последние три цикла в списке работают на основе `WP_Query()`.

## query_posts()
`query_posts()` и стандартный цикл `if(have_posts())` технически аболютно одинаковы.  
`if(have_posts())` - проверяет, есть посты в запросе (массиве записей, глобальной переменной) `$wp_query`.

В стандартном цикле мы не указываем никаких данных для выборки, данные выбираются автоматически в зависимости от URL страницы. Данные сразу находятся в `$wp_query`. WordPress автоматически делает запрос к БД и записывает результат запроса в `$wp_query`. Стандартный цикл `if(have_posts())` используется для базовых страниц.

`query_posts()` - позволяет изменить базовый запрос и вывести нужный нам вариант записей.

Меняем стандартный запрос с помощью `query_posts()`:

    global $query_string;        // параметры базового запроса
    query_posts( $query_string .'&order=ASC' ); // параметры базового запроса + свои
    if(have_posts()) ...         // стандартный цикл
    wp_reset_query();            // сброс запроса

Еще пример своего запроса (параметры разделяются `&`):

    cat=-6,-9&order=ASC&posts_per_page=20

- `p=9` - пост с id 9
- `cat=-6` - исключить категорию 6 из выборки

`wp_reset_query()` - после выполнения цикла, нужно обязательно сбрасывать базовый запрос, который изменён query_posts(). Потому что query_posts() переписывает глобальную переменную `$wp_query`.

Преимущество запроса `query_posts()` в том, что пагинация тоже подстраивается при изменении `posts_per_page`. query_post() меняет данные глобальной переменной $wp_query, а пагинация строится именно на основе этих данных.

Изменять базовый запрос WP рекомендуется через фильтр pre_get_posts, а не через query_posts().

Не используем `global $query_string;`:

    query_posts( 'order=ASC' );
    
Базовый запрос полностью стирается и создаётся новый, так тоже работает, но делать не рекомендуется.

Когда использовать query_posts()? Когда нужно немного изменить базовый запрос, например:
- исключить рубрику, метку и т.д.
- изменить сортировку
- ограничить количество выводимых постов
- исключить посты из рубрики, метки
- и т.п.

Не нужно использовать query_posts():
- для создания нескольких циклов на одной странице
- для вывода в сайдбар списка постов
- для создания дополнительного вывода записей и т.п.

Для этих целей используйте цикл `get_posts()` у него такие же параметры как и у query_posts().

## WP_Query()
Циклы `WP_Query()` используются для вывода постов не связанных с текущей страницей и создания множественных циклов. У `WP_Query()` те же парамаетры что и у query_posts().

Выведем все записи из категории 9, отключим панинацию:

    $query = new WP_Query( 'cat=9&nopaging=1' );
    if( $query->have_posts() ){
      while( $query->have_posts() ){
        $query->the_post();
        ?>
        <h2><a href="<?php the_permalink(); ?>"><?php the_title(); ?></a></h2>
        <?php the_content(); ?>
        <?php
      }
      wp_reset_postdata(); // сбрасываем переменную $post
    }
    else
      echo 'Записей нет.';
    ?>

После запроса `$query` можно создавать еще запросы с циклами $query2, $query3 и т.д. Особенность циклов на WP_Query() в том, что при создании объекта $query, он никак не связан с аналогичным глобальным объектом $wp_query, поэтому структура текущей страницы не нарушается.

`$query` также используется для различного рода проверок:
- записи из каких страниц используются в запросе
- сколько всего записей `$query->found_posts`
- создание дополнительных запросов с пагинацией

Зачем нужен `wp_reset_postdata()`? После срабатывания внутри цикла `$query->the_post()` в `$post` записываются данные текущего поста. После срабатывания всего цикла в этой переменной остаются данные последнего поста из массива записей, но в этой переменной нужно чтобы всегда сохранялись данные текущей страницы. `wp_reset_postdata()` сбрасывает данные `$post` и возвращает их в то положение какое было до срабатывания кастомного цикла.

Когда использовать `WP_Query()`:
- для вывода записей не затрагивая основной цикл
- для вывода записей в сайдбаре
- для создания множественных запросов
- и т.д.

## get_posts()
По словам создателя сайта wp-kama.ru, вместо `WP_Query()` удобнее использовать `get_posts()`.

get_posts() чаще всего используют для:
- вывода последних 5 записей в сайдбаре
- вывода случайных 8 записей в подвале
- вывода всех изображений прикрепленных к посту
- вывода записей у которых есть определенное произвольное поле

Пример вывода 5 записей из рубрики 9:

    global $post; // не обязательно

    // 5 записей из рубрики 9
    $myposts = get_posts(array(
      'category' => 9
    ) );

    foreach( $myposts as $post ){
      setup_postdata( $post );
      // стандартный вывод записей
    }

    wp_reset_postdata(); // сбрасываем переменную $post

5 записей выведется потому что по умолчанию он выводит именно столько. Если нужно вывести все записи, то можно добавить `'nopaging' => 1` или `'posts_per_page' => -1`.

get_posts() рекомендуется использовать практически всегда для пользовательских циклов:
- вывод записей из БД в любом месте шаблона
- создания нескольких циклов
- и многое другое

## Итого
Где и какой из 3-х вариантов циклов использовать:
- `query_posts()` - если нужно изменить/подправить стандартный вывод записей на страницах WordPress. Можно использовать 1 раз на странице.
- `get_posts()` - если нужно вывести записи из БД. Можно использовать сколько угодно раз на странице.
- `WP_Query()` - во всех других случаях когда не подошли query_posts() и get_posts(). Класс WP_Query() является ядром query_posts() и get_posts() и может быть использован для каких-либо сложных случаев вывода.

Параметры у всех циклов одинаковы: https://wp-kama.ru/function/wp_query
