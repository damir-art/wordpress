# 4 вида циклов
- стандартный
- кастомные:
  - WP_Query{},
  - query_posts(),
  - get_posts().

Отличный вопрос! Давайте разберемся, когда и какой метод лучше использовать для создания кастомных циклов в WordPress.

## WP_Query{}
`WP_Query` - это основной класс для создания запросов к базе данных WordPress. Он предлагает наибольший набор функций и возможностей для настройки запроса.

**Когда использовать:**  
Используйте `WP_Query`, если вам нужна максимальная гибкость и контроль над запросом. Этот метод подходит практически для любых задач, связанных с выборкой постов, страниц, пользовательских типов записей и других объектов.

**Пример использования:**

```php
$args = array(
  'post_type' => 'post',
  'posts_per_page' => 5,
  'orderby' => 'title',
  'order' => 'ASC'
);
$query = new WP_Query($args);

if ($query->have_posts()) {
  while ($query->the_post()) {
    the_title();
    the_content();
  }
}
wp_reset_postdata();
```

**Преимущества:**
- Максимальная гибкость и контроль над запросом.
- Поддерживает сложные условия фильтрации и сортировки.
- Безопасен и рекомендуется для большинства случаев.

**Недостатки:**
- Требует немного больше кода по сравнению с другими методами.

---

## query_posts()
`query_posts()` изменяет главный запрос WordPress, что делает его менее предпочтительным методом для создания кастомных циклов.

**Когда использовать:**  
**Никогда.** Официальная документация WordPress рекомендует избегать использования этой функции, поскольку она может приводить к неожиданному поведению и проблемам с производительностью.

**Почему не стоит использовать:**  
- Изменяет главный запрос, что может повлиять на другие части сайта.
- Может вызывать проблемы с кэшированием и производительность.
- Труднее поддерживать и отлаживать.

---

## get_posts()
`get_posts()` — это упрощенная версия `WP_Query`, которая возвращает массив постов вместо объекта запроса.

**Когда использовать:**  
Используйте `get_posts()`, если вам нужно быстро получить список постов без необходимости проходить через цикл. Это удобно для простых задач, таких как получение списка последних постов или создание виджета.

**Пример использования:**

```php
$args = array(
  'numberposts' => 5,
  'orderby' => 'title',
  'order' => 'ASC'
);
$posts = get_posts($args);
foreach ($posts as $post) {
  setup_postdata($post);
  the_title();
  the_content();
}
wp_reset_postdata();
```

**Преимущества:**
- Простота использования для небольших задач.
- Возвращает массив постов, что может быть удобнее для обработки.

**Недостатки:**
- Меньшая гибкость по сравнению с `WP_Query`.
- Ограниченный набор параметров.

---

### Итог

- **Лучший вариант:** Используйте `WP_Query` для максимальной гибкости и контроля над запросом. Это самый мощный и рекомендуемый инструмент для создания кастомных циклов.
- **Альтернатива:** Используйте `get_posts()`, если вам нужно быстро получить список постов для простых задач.
- **Избегайте:** Никогда не используйте `query_posts()`, так как это может привести к проблемам с производительностью и непредсказуемым результатам.

# Старая запись
# Что такое цикл в WordPress (the loop)
Цикл WordPress - это перебор записей (постов) и вывод информации о посте в цикле.  
Цикл получает массив записей, каждая запись это объект. В WordPress есть специальные функции используемые внутри цикла, для получения той или иной информации о посте.

Цикл используется в таких файл-шаблонах как: index.php, category.php, tag.php

## Как выглядит цикл
Код стандартного цикла WordPress:

    <!-- Цикл WordPress -->
    <?php if ( have_posts() ) : while ( have_posts() ) : the_post(); ?>
      <h3><a href="<?php the_permalink() ?>"><?php the_title() ?></a></h3>
      <?php the_content() ?>
    <?php endwhile; else : ?>
      <p>Записей нет.</p>
    <?php endif; ?>

Другие виды записей циклов смотрите ниже.  
Вся информация о записи (посте), хранится в глобальной переменной `$post`.  
Переменная `$post` создаётся внутри цикла для каждой записи.  
До цикла, функция `have_posts()` обращается к массиву записей, глобальной переменной `$wp_query`, данные в этой переменной в зависимости от страницы (одиночная, архив) будут разные.  
Создать массив записей $wp_query и получить из него данные можно также через пользовательские циклы.  
В зависимости от количества записей в цикле, переменная `$post` меняется столько же раз.  
Функции цикла WordPress, типа `the_title()`, берут информацию из `$post`.

Глобальная переменная `$wp_query` - хранит массив записей, результат запроса к БД. Массив записей затем обрабатывается циклом. `$wp_query` используется в стандартном цикле и цикле `query_posts()`.

Глобальная переменной `$query_string`, содержит базовый запрос для функции query_posts.

## Что содержится внутри $wp_query и $post
Что содержится внутри глобальных переменных `$wp_query` и `$post` можно узнать через print_r():

    <?php
      echo '<pre>';
      print_r($wp_query);
      echo '</pre>';
    ?>

    <!-- Цикл WordPress -->
    <?php if ( have_posts() ) : while ( have_posts() ) : the_post(); ?>
      <?php
        echo '<pre>';
        print_r($post);
        echo '</pre>';
      ?>
      <h3><a href="<?php the_permalink() ?>"><?php the_title() ?></a></h3>
      <?php the_content() ?>
    <?php endwhile; else : ?>
      <p>Записей нет.</p>
    <?php endif; ?>

## Функции цикла
Функции цикла, работают только внутри цикла (их еще называют тегами шаблонов):

- the_title()     - выводит заголовок записи
- the_excerpt()   - выводит отрывок контента записи
- the_content()   - выводит контент записи
- the_permalink() - выводит ссылку на запись
- the_date()      - выводит дату создания записи

Чтобы тег шаблона сработал, нужно определить переменную `$post` которая не известна за пределами цикла или может быть не корректной (содержать данные последнего обработанного в цикле поста).

Полный список тегов шаблона: https://wp-kama.ru/functions/template-tags

## Как еще можно записать цикл?

    <?php if ( have_posts() ) { while ( have_posts() ) { the_post(); ?>
      <!-- Цикл WordPress -->
      <!-- Вывод постов: the_title() и т.д. -->
    <?php } } else { ?>
      <p>Записей нет.</p>
    <?php } ?>

Сначала while():

    <?php while ( have_posts() ){ the_post(); ?>
      <!-- Цикл WordPress -->
      <!-- Вывод постов: the_title() и т.д. -->
    <?php } ?>
    <?php if ( ! have_posts() ){ ?>
      <p>Записей нет.</p>
    <?php } ?>

Полный пример цикла, взятый с `wp-kama.ru`:

    <!-- Проверка наличия записей в цикле -->
    <?php if ( have_posts() ) : ?>
      <!-- Начало цикла -->
      <?php while ( have_posts() ) : the_post(); ?>
        <!-- Цикл WordPress -->
        <!-- Здесь уже определилась переменная $post, -->
        <!-- на основе которой будет строится дальнейший код. -->
        <!-- $post будет меняться для каждого поста while( have_posts() ). -->
        <!-- $post нужна, чтобы работали теги шаблона: in_category('3'), the_permalink() и т.д. -->

        <!-- Проверка находится ли этот пост в категории 3. -->
        <!-- Если да, то для div задаем CSS класс class="post-cat-three". -->
        <!-- Если нет, то класс будет post class="post". -->
        <?php if ( in_category('3') ) { ?>
          <div class="post-cat-three">
        <?php } else { ?>
          <div class="post">
        <?php } ?>

          <!-- Выводим заголовок поста, как ссылку на сам пост. -->
          <h2><a href="<?php the_permalink() ?>" title="Ссылка на: <?php the_title_attribute(); ?>"><?php the_title(); ?></a></h2>

          <!-- Выводим дату поста и ссылку на другие записи автора. -->
          <small><?php the_time('F jS, Y') ?> Автор: <?php the_author_posts_link() ?></small>

          <!-- Выводим текст поста в теге div. -->
          <div class="entry">
            <?php the_content(); ?>
          </div>

          <!-- Выводим категории поста, через запятую. -->
          <p class="postmetadata">Расположено в <?php the_category(', '); ?></p>
        </div> <!-- закрываем основной тег div -->

        <!-- Отсюда цикл начинает повторятся, если есть еще посты -->
        <!-- Останавливаем цикл (endwhile), -->
      <?php endwhile; ?>
      <!-- Полное окончание цикла. -->

    <!-- Если записей в цикле нет - цикл не сработал (else) -->
    <?php else: ?>
      <p>Нет постов в цикле.</p>
    <?php endif; ?>

## Что находится внутри переменной $post

    WP_Post Object
    (
        [ID] => 8
        [post_author] => 1
        [post_date] => 2022-10-06 12:06:08
        [post_date_gmt] => 2022-10-06 09:06:08
        [post_content] => Текст записи 1
        [post_title] => Запись 1
        [post_excerpt] => 
        [post_status] => publish
        [comment_status] => open
        [ping_status] => open
        [post_password] => 
        [post_name] => zapis-1
        [to_ping] => 
        [pinged] => 
        [post_modified] => 2022-10-06 12:06:08
        [post_modified_gmt] => 2022-10-06 09:06:08
        [post_content_filtered] => 
        [post_parent] => 0
        [guid] => http://wpboo.loc/?p=8
        [menu_order] => 0
        [post_type] => post
        [post_mime_type] => 
        [comment_count] => 0
        [filter] => raw
    )

Прописывать ли `global $post;` перед циклом?

Нет не обязательно. Глобальная переменная будет использована методами, её обязательно нужно сбросить после цикла! Если она тебе нужна где-то в цикле, например из нее нужны какие-то данные, то можно перед циклом указать global $post; и использовать эту переменную внутри цикла. Данные в ней будут меняться по ходу цикла.

## Разное
- `get_query_var()` - получает переменные запроса (параметры запроса) из WP_Query, который устанавливается в глобальную переменную $wp_query
- `$paged = get_query_var('paged') ? get_query_var('paged') : 1;` -  получим текущий номер страницы пагинации

Пагинация в пользовательском цикле:

    echo paginete_links(
      array(
        'type'    => 'list',
        'current' => max(1, get_query_var('paged')),
        'total'   => $wp_query->max_num_pages,
      )
    );
